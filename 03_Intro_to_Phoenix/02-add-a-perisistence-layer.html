<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="google-site-verification" content="R6ba5MLXyH1nPWUW2FaRbcaaqid5fFEUiymqWpcGEFc" />

  <title>Adding a Persistence layer</title>
  <meta name="description" content="We empower people with technology through teaching and facilitating access, enlarging the community of people who give back and teach others.
">
  
  <meta name="author" content="ElixirBridge">
  <meta name="copyright" content="&copy; ElixirBridge 2019">
  

  <!-- External libraries -->
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/monokai_sublime.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.7.1/css/lightbox.css">

  <!-- Favicon and other icons (made with http://www.favicon-generator.org/) -->
  <link rel="shortcut icon" href="/elixir-bridge.github.io/assets/icons/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/elixir-bridge.github.io/assets/icons/favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" sizes="57x57" href="/elixir-bridge.github.io/assets/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/elixir-bridge.github.io/assets/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/elixir-bridge.github.io/assets/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/elixir-bridge.github.io/assets/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/elixir-bridge.github.io/assets/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/elixir-bridge.github.io/assets/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/elixir-bridge.github.io/assets/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/elixir-bridge.github.io/assets/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/elixir-bridge.github.io/assets/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/elixir-bridge.github.io/assets/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/elixir-bridge.github.io/assets/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/elixir-bridge.github.io/assets/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/elixir-bridge.github.io/assets/icons/favicon-16x16.png">
  <link rel="manifest" href="/elixir-bridge.github.io/assets/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/elixir-bridge.github.io/assets/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">

  
  <!-- Facebook OGP cards -->
  <meta property="og:description" content="We empower people with technology through teaching and facilitating access, enlarging the community of people who give back and teach others.
" />
  <meta property="og:url" content="" />
  <meta property="og:site_name" content="ElixirBridge for Girls" />
  <meta property="og:title" content="Adding a Persistence layer" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="/elixir-bridge.github.io/assets/logo.png" />
  <meta property="og:image:type" content="image/png" />
  <meta property="og:image:width" content="612" />
  <meta property="og:image:height" content="605" />
  

  
  <!-- Twitter: card tags -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Adding a Persistence layer">
  <meta name="twitter:description" content="We empower people with technology through teaching and facilitating access, enlarging the community of people who give back and teach others.
">
  <meta name="twitter:image" content="/elixir-bridge.github.io/assets/logo.png">
  <meta name="twitter:url" content="">
  

  

  <!-- Site styles -->
  <link rel="stylesheet" href="/elixir-bridge.github.io/css/main.css">
  <link rel="canonical" href="/elixir-bridge.github.io/03_Intro_to_Phoenix/02-add-a-perisistence-layer.html">
  <link rel="alternate" type="application/rss+xml" title="ElixirBridge for Girls" href="/elixir-bridge.github.io/feed.xml" />
</head>


  <body>

    <header class="navigation" role="banner">
  <div class="navigation-wrapper">
    <a href="/elixir-bridge.github.io/" class="logo">
      
      <img src="/elixir-bridge.github.io/assets/logo.png" alt="ElixirBridge for Girls">
      
    </a>
    <a href="javascript:void(0)" class="navigation-menu-button" id="js-mobile-menu">
      <i class="fa fa-bars"></i>
    </a>
  </div>
</header>


    <div class="page-wrapper">
      <div class="sidebar">
  <!-- get the sections -->




<!-- make them an array -->



<h4>
  
    <a href="/docs">Docs</a>
  
</h4>


<!-- spit them out as a list of lists -->

  

  
    <h4>Installfest</h4>
    <ul class="sidebar-list">
    
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/01_Installfest/01-begin-installfest.html'>Installfest</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/01_Installfest/02-choose-your-own-operating-system.html'>Choose your own operating system</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/01_Installfest/03-macintosh-osx-setup.html'>Mac OSX setup</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/01_Installfest/03-windows-setup.html'>Windows setup</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/01_Installfest/04-install-and-configure-git.html'>Install and Configure git</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/01_Installfest/05-install-elixir-and-phoenix.html'>Install Elixir and Phoenix</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/01_Installfest/06-create-an-ssh-key.html'>Create an SSH Key</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/01_Installfest/07-create-a-heroku-account.html'>Create a Heroku Account</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/01_Installfest/08-create-phoenix-app.html'>Create a Phoenix App</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/01_Installfest/09-generate-a-database-model.html'>Generate a Database Model</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/01_Installfest/10-deploy-a-phoenix-app.html'>Deploy a Phoenix App</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/01_Installfest/11-deploy-to-heroku.html'>Deploy to Heroku</a></li>
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    </ul>
  

  
    <h4>Intro to Elixir</h4>
    <ul class="sidebar-list">
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/02_Intro_to_Elixir/01-why-program-why-elixir.html'>Why program? Why elixir?</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/02_Intro_to_Elixir/03-learning-elixir.html'>Learning Elixir</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/02_Intro_to_Elixir/04-elixir-types.html'>Elixir Types</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/02_Intro_to_Elixir/05-operators-and-variables.html'>Operators and Variables</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/02_Intro_to_Elixir/05.5-anonymous-functions-lists-and-tuples.html'>Lists and Tuples</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/02_Intro_to_Elixir/05.6-keyword-lists.html'>Keyword Lists</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/02_Intro_to_Elixir/05.7-maps-and-nested-data-structures.html'>Maps and Nested Data Structures</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/02_Intro_to_Elixir/05.9-enumerables.html'>Enumerables</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/02_Intro_to_Elixir/06-pattern-matching.html'>Pattern Matching</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/02_Intro_to_Elixir/06.4-modules.html'>Modules</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/02_Intro_to_Elixir/06.5_Functions.html'>Functions</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/02_Intro_to_Elixir/08-keyword-lists.html'>Keyword Lists</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/02_Intro_to_Elixir/09-maps-and-nested-data-structures.html'>Maps and Nested Data Structures</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/02_Intro_to_Elixir/12-recursion.html'>Recursion</a></li>
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    </ul>
  

  
    <h4>Intro to Phoenix</h4>
    <ul class="sidebar-list">
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/03_Intro_to_Phoenix/01-creating-a-chat-app.html'>Creating a Chat App</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/03_Intro_to_Phoenix/02-add-a-perisistence-layer.html'>Adding a Persistence layer</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/03_Intro_to_Phoenix/13-create-a-phoenix-app.html'>Create a Phoenix App</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/03_Intro_to_Phoenix/14-running-the-application-locally.html'>Running the Application Locally</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/03_Intro_to_Phoenix/15-creating-a-migration.html'>Creating a Migration</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/03_Intro_to_Phoenix/16-phoenix-architecture.html'>Phoenix architecture</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/03_Intro_to_Phoenix/17-CRUD-with-scaffolding.html'>CRUD with scaffolding</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/03_Intro_to_Phoenix/18-setting-the-default-page.html'>Setting the Default Page</a></li>
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    </ul>
  

  
    <h4>Mix Applications</h4>
    <ul class="sidebar-list">
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/04_Mix_Applications/01-mix.html'>Mix</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/04_Mix_Applications/02-adding-dependencies.html'>Adding dependencies</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/04_Mix_Applications/03-testing.html'>Testing</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/04_Mix_Applications/04-set-up-my-app.html'>Our first application</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/04_Mix_Applications/05-interacting-with-iex.html'>Interacting with iex</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/04_Mix_Applications/06-environments.html'>Environments</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/04_Mix_Applications/07-documentation.html'>Documentation</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/04_Mix_Applications/12-supervisors.html'>Supervisors</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/04_Mix_Applications/13-router.html'>Router</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/04_Mix_Applications/14-plugs.html'>Plugs</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/04_Mix_Applications/15-plug-router.html'>Plug.Router</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/04_Mix_Applications/16-templating.html'>Templating</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/04_Mix_Applications/16.5-genserver.html'>GenServer</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/04_Mix_Applications/17-deployment.html'>Deployment</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/04_Mix_Applications/18-dockerfile.html'>Docker and the Dockerfile</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/04_Mix_Applications/19-distillery-config.html'>Distillery</a></li>
      
    
      
        <li class="sidebar-list-item"><a href='/elixir-bridge.github.io/04_Mix_Applications/20-running-docker.html'>Running docker</a></li>
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    </ul>
  


</div>

      <div class="page-content">
          <div class="wrapper">
<div class="page">

  <header class="post-header">
    <h1 class="post-title">Adding a Persistence layer</h1>
  </header>

  <article class="post-content">
    <p>We have a basic chat app working now, but what happens if you reload the page? Poof! Everything is gone. Some history would be nice, wouldn’t it?</p>

<h1 id="goals">Goals</h1>

<ul>
  <li>Add a schema for chat messages</li>
  <li>Save lines of chat to a database</li>
  <li>Understand asynchronous request handling</li>
</ul>

<h2 id="steps">Steps</h2>

<h3 id="generate-the-schema">Generate the schema</h3>

<p>In Phoenix, schemas represent the structures of your database tables. At this point, we have no tables, so we’ll use a schema to define one and then run a migration to actually create the table in the database. This is analogous to “models” in other frameworks. Migrations are pieces of code that create or change database structure.</p>

<p>We have Mix helpers to create the schema definition and then run the migration in the terminal:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mix phx.gen.schema Message messages name:string message:string
mix ecto.migrate
</code></pre></div></div>

<h3 id="save-each-message-as-it-comes-in">Save each message as it comes in</h3>

<p>Next, we need to save the messages as they come in. In <code class="highlighter-rouge">lib/chatter_web/channels/chat_room_channel.ex</code>, we can add a call to do it, so the <code class="highlighter-rouge">handle_in/3</code> function looks like this:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="n">handle_in</span><span class="p">(</span><span class="sd">"</span><span class="s2">new_message"</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
  <span class="no">Chatter</span><span class="o">.</span><span class="no">Message</span><span class="o">.</span><span class="n">changeset</span><span class="p">(%</span><span class="no">Chatter</span><span class="o">.</span><span class="no">Message</span><span class="p">{},</span> <span class="n">payload</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="no">Chatter</span><span class="o">.</span><span class="no">Repo</span><span class="o">.</span><span class="n">insert</span>
  
  <span class="n">broadcast!</span> <span class="n">socket</span><span class="p">,</span> <span class="sd">"</span><span class="s2">new_message"</span><span class="p">,</span> <span class="n">payload</span>
  <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="make-it-faster">Make it faster</h3>

<p>The above code works, but what happens when we have a million people in our channel? Those inserts are happening synchronously. All those saves will slow down the request cycle and keep us from handling the traffic efficiently.</p>

<p>Elixir has some built in tools for dealing with exactly this situation. Specifically, <code class="highlighter-rouge">Kernel.spawn/1</code>, which takes a function to call, in this case <code class="highlighter-rouge">save_message/1</code> with our message. So we’ll change our handler and add that function:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="n">handle_in</span><span class="p">(</span><span class="sd">"</span><span class="s2">new_message"</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">spawn</span><span class="p">(</span><span class="k">fn</span> <span class="o">-&gt;</span> <span class="n">save_message</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span> <span class="k">end</span><span class="p">)</span>
  <span class="n">broadcast!</span> <span class="n">socket</span><span class="p">,</span> <span class="sd">"</span><span class="s2">new_message"</span><span class="p">,</span> <span class="n">payload</span>
  <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
<span class="k">end</span>

<span class="k">defp</span> <span class="n">save_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="k">do</span>
  <span class="no">Chatter</span><span class="o">.</span><span class="no">Message</span><span class="o">.</span><span class="n">changeset</span><span class="p">(%</span><span class="no">Chatter</span><span class="o">.</span><span class="no">Message</span><span class="p">{},</span> <span class="n">message</span><span class="p">)</span>
    <span class="o">|&gt;</span> <span class="no">Chatter</span><span class="o">.</span><span class="no">Repo</span><span class="o">.</span><span class="n">insert</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This immediately creates a new process to do the save, outside of the request cycle. Since we don’t need to see the results of the save to broadcast the message, there’s no reason to wait for it. This change allows our chat app to host a very large number of users all chatting at the same time with their chat being saved to the database.</p>

<h3 id="display-recent-messages-when-a-user-joins-the-channel">Display recent messages when a user joins the channel</h3>

<p>So, we have some messages saved, but it would be nice to see them when joining the channel so we have some context on the chat going on. To do that, we have to change the <code class="highlighter-rouge">join/3</code> function to return a list of messages, and have the message list box on the page display those messages. Unfortunately, we can’t send all those messages to the channel we’re joining until after the <code class="highlighter-rouge">join/3</code> function has returned. And by then it’s too late.</p>

<p>What to do?</p>

<p>Elixir helps us out here. Under the hood we’re working with an Elixir <code class="highlighter-rouge">Process</code>, and each Elixir process has a mailbox. We’re going to send a message to our own process mailbox using the <code class="highlighter-rouge">send/2</code> function. Then, in the future, our process is going to read it and carry out the instructions it finds there.</p>

<p>In the code below, we use <code class="highlighter-rouge">send/2</code>, specifying the process mailbox to send the message to – in this case it’s our own process – and a function to call when it handles the message in the mailbox. This is all going to happen after the <code class="highlighter-rouge">join/3</code> function is finished and we are fully joined to the channel.</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="n">join</span><span class="p">(</span><span class="sd">"</span><span class="s2">chat_room:lobby"</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
  <span class="k">if</span> <span class="n">authorized?</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">send</span><span class="p">(</span><span class="n">self</span><span class="p">(),</span> <span class="ss">:after_join</span><span class="p">)</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
  <span class="k">else</span>
    <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="p">%{</span><span class="ss">reason:</span> <span class="sd">"</span><span class="s2">unauthorized"</span><span class="p">}}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Now, we’ll need to handle this message using a new handler called <code class="highlighter-rouge">handle_info/2</code>. This is a callback on <code class="highlighter-rouge">Phoenix.Channel</code> that takes care of executing calls not related to requests and responses from sockets. Think of it as a catchall for function calls to the channel.</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="n">handle_info</span><span class="p">(</span><span class="ss">:after_join</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
  <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Now this <code class="highlighter-rouge">handle_info/2</code> will get called after the socket has been connected. We can do anything we want in here. Let’s fetch the most recent messages and send them (one-by-one) to our socket.</p>

<h3 id="fetching-most-recent-messages">Fetching most recent messages</h3>

<p>Since we’re going to be getting these messages a lot, it makes sense to put that code in the schema for messages, <code class="highlighter-rouge">lib/chatter/message.ex</code>. We can add the following function to our module, after the <code class="highlighter-rouge">changeset/2</code> function:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="n">recent_messages</span><span class="p">(</span><span class="n">limit</span> <span class="p">\\</span> <span class="m">10</span><span class="p">)</span> <span class="k">do</span>
  <span class="no">Chatter</span><span class="o">.</span><span class="no">Repo</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="no">Chatter</span><span class="o">.</span><span class="no">Message</span><span class="p">,</span> <span class="ss">limit:</span> <span class="n">limit</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This gives us a default of 10 messages, which will work well for our current case.</p>

<p>Now, we can add this to our channel  <code class="highlighter-rouge">handle_info/3</code> call.</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="n">handle_info</span><span class="p">(</span><span class="ss">:after_join</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
  <span class="no">Chatter</span><span class="o">.</span><span class="no">Message</span><span class="o">.</span><span class="n">recent_messages</span><span class="p">()</span>
  <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Next, we need to broadcast the messages to the channel so they show up in the message list. Elixir’s <code class="highlighter-rouge">Enum.each/2</code> will let us step through each message returned by <code class="highlighter-rouge">recent_messages()</code> and send it as a new message to the channel with the <code class="highlighter-rouge">Channel.push/3</code> function.</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="n">handle_info</span><span class="p">(</span><span class="ss">:after_join</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
  <span class="no">Chatter</span><span class="o">.</span><span class="no">Message</span><span class="o">.</span><span class="n">recent_messages</span><span class="p">()</span>
  <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">each</span><span class="p">(</span><span class="k">fn</span> <span class="n">msg</span> <span class="o">-&gt;</span> <span class="n">push</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="sd">"</span><span class="s2">new_message"</span><span class="p">,</span> <span class="p">%{</span>
    <span class="ss">name:</span> <span class="n">msg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
    <span class="ss">message:</span> <span class="n">msg</span><span class="o">.</span><span class="n">message</span>
  <span class="p">})</span> <span class="k">end</span><span class="p">)</span>
  <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>

<p>When we reload the page, we should see 10 recent messages in the chat history.
But there’s something about this <code class="highlighter-rouge">handle_info</code> function that looks cluttered. Let’s clean it up a little by separating the message formatting.</p>

<p>First, let’s add another private function, <code class="highlighter-rouge">format_msg/1</code>.</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defp</span> <span class="n">format_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">do</span>
  <span class="p">%{</span>
    <span class="ss">name:</span> <span class="n">msg</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
    <span class="ss">message:</span> <span class="n">msg</span><span class="o">.</span><span class="n">message</span>
  <span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Now let’s use that new function by replacing that inline formatting.</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">def</span> <span class="n">handle_info</span><span class="p">(</span><span class="ss">:after_join</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">Chatter</span><span class="o">.</span><span class="no">Message</span><span class="o">.</span><span class="n">recent_messages</span><span class="p">()</span>
    <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">each</span><span class="p">(</span><span class="k">fn</span> <span class="n">msg</span> <span class="o">-&gt;</span> <span class="n">push</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="sd">"</span><span class="s2">new_message"</span><span class="p">,</span> <span class="n">format_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span> <span class="k">end</span><span class="p">)</span>
    <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="n">socket</span><span class="p">}</span>
  <span class="k">end</span>
</code></pre></div></div>

<p>All right, that gives us a better user experience for new folks joining the room.</p>

  </article>
  
  
  
  
    <h4>Next step: </h4>
    <p>Go on to <a href="/03_Intro_to_Phoenix/13-create-a-phoenix-app.html">Create a Phoenix App</a>.</p>
  
  
    <h4>Or:</h4>
    <p>Go back to <a href="/03_Intro_to_Phoenix/01-creating-a-chat-app.html">Creating a Chat App</a>.</p>
  



</div>
</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h3 class="footer-heading">ElixirBridge for Girls</h3>

    <div class="site-contact">

      <p><strong>Contact</strong></p>
      <ul class="social-media-list">
        <li>
          <a href="mailto:info@elixirbridge.org">
            <i class="fa fa-envelope-o"></i>
            <span class="username">info@elixirbridge.org</span>
          </a>
        </li>

        
          
          <li>
            <a href="https://twitter.com/elixirbridge" title="Twitter">
              <i class="fa fa-twitter"></i>
              <span class="username">elixirbridge</span>
            </a>
          </li>
          
        
          
          <li>
            <a href="https://github.com/elixir-bridge" title="GitHub">
              <i class="fa fa-github"></i>
              <span class="username">elixirbridge</span>
            </a>
          </li>
          
        

      </ul>
    </div>

    <div class="site-signature">
      <p class="rss-subscribe text"><strong>Subscribe <a href="/elixir-bridge.github.io/feed.xml">via RSS</a></strong></p>
      <p class="text">We empower people with technology through teaching and facilitating access, enlarging the community of people who give back and teach others.
</p>
    </div>

  </div>

</footer>

<!-- Scripts -->
<script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.7.1/js/lightbox.min.js"></script>
<script>

$(document).ready(function() {

  // Syntax highlighting
  hljs.initHighlightingOnLoad();

  const hamburgerMenu = document.getElementById("js-mobile-menu")
  const sidebar = document.getElementsByClassName("sidebar")[0]

  hamburgerMenu.addEventListener("click", () => {
    sidebar.classList.toggle("mobile-show")
  })
});

</script>




  </body>

</html>
